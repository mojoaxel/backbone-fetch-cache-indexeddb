/**
 * @see https://github.com/mojoaxel/backbone-fetch-cache-indexeddb#backbone-fetch-cache-indexeddb
 * @copyright 2017 by Alexander Wunschik <mail@wunschik.it>
 * @version 0.2.0
 * @license MIT
 */
!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){!function(a,c,d){"use strict";"function"==typeof define?define(c):"undefined"!=typeof b&&b.exports?b.exports=c():d[a]=c()}("IDBStore",function(){"use strict";function a(a,b){var c,d;for(c in b)d=b[c],d!==h[c]&&d!==a[c]&&(a[c]=d);return a}function b(a){return"error"in a.target?"VersionError"==a.target.error.name:"errorCode"in a.target&&12==a.target.errorCode}var c=function(a){throw a},d=function(){},e={storeName:"Store",storePrefix:"IDBWrapper-",dbVersion:1,keyPath:"id",autoIncrement:!0,onStoreReady:function(){},onError:c,indexes:[],implementationPreference:["indexedDB","webkitIndexedDB","mozIndexedDB","shimIndexedDB"]},f=function(a,b){"undefined"==typeof b&&"function"==typeof a&&(b=a),"[object Object]"!=Object.prototype.toString.call(a)&&(a={});for(var c in e)this[c]="undefined"!=typeof a[c]?a[c]:e[c];this.dbName=this.storePrefix+this.storeName,this.dbVersion=parseInt(this.dbVersion,10)||1,b&&(this.onStoreReady=b);var d="object"==typeof window?window:self,f=this.implementationPreference.filter(function(a){return a in d});this.implementation=f[0],this.idb=d[this.implementation],this.keyRange=d.IDBKeyRange||d.webkitIDBKeyRange||d.mozIDBKeyRange,this.consts={READ_ONLY:"readonly",READ_WRITE:"readwrite",VERSION_CHANGE:"versionchange",NEXT:"next",NEXT_NO_DUPLICATE:"nextunique",PREV:"prev",PREV_NO_DUPLICATE:"prevunique"},this.openDB()},g={constructor:f,version:"1.7.1",db:null,dbName:null,dbVersion:null,store:null,storeName:null,storePrefix:null,keyPath:null,autoIncrement:null,indexes:null,implementationPreference:null,implementation:"",onStoreReady:null,onError:null,_insertIdCount:0,openDB:function(){var a=this.idb.open(this.dbName,this.dbVersion),c=!1;a.onerror=function(a){if(b(a))this.onError(new Error("The version number provided is lower than the existing one."));else{var c;if(a.target.error)c=a.target.error;else{var d="IndexedDB unknown error occurred when opening DB "+this.dbName+" version "+this.dbVersion;"errorCode"in a.target&&(d+=" with error code "+a.target.errorCode),c=new Error(d)}this.onError(c)}}.bind(this),a.onsuccess=function(a){if(!c){if(this.db)return void this.onStoreReady();if(this.db=a.target.result,"string"==typeof this.db.version)return void this.onError(new Error("The IndexedDB implementation in this browser is outdated. Please upgrade your browser."));if(!this.db.objectStoreNames.contains(this.storeName))return void this.onError(new Error("Object store couldn't be created."));var b=this.db.transaction([this.storeName],this.consts.READ_ONLY);this.store=b.objectStore(this.storeName);var d=Array.prototype.slice.call(this.getIndexList());this.indexes.forEach(function(a){var b=a.name;if(!b)return c=!0,void this.onError(new Error("Cannot create index: No index name given."));if(this.normalizeIndexData(a),this.hasIndex(b)){var e=this.store.index(b),f=this.indexComplies(e,a);f||(c=!0,this.onError(new Error('Cannot modify index "'+b+'" for current version. Please bump version number to '+(this.dbVersion+1)+"."))),d.splice(d.indexOf(b),1)}else c=!0,this.onError(new Error('Cannot create new index "'+b+'" for current version. Please bump version number to '+(this.dbVersion+1)+"."))},this),d.length&&(c=!0,this.onError(new Error('Cannot delete index(es) "'+d.toString()+'" for current version. Please bump version number to '+(this.dbVersion+1)+"."))),c||this.onStoreReady()}}.bind(this),a.onupgradeneeded=function(a){if(this.db=a.target.result,this.db.objectStoreNames.contains(this.storeName))this.store=a.target.transaction.objectStore(this.storeName);else{var b={autoIncrement:this.autoIncrement};null!==this.keyPath&&(b.keyPath=this.keyPath),this.store=this.db.createObjectStore(this.storeName,b)}var d=Array.prototype.slice.call(this.getIndexList());this.indexes.forEach(function(a){var b=a.name;if(b||(c=!0,this.onError(new Error("Cannot create index: No index name given."))),this.normalizeIndexData(a),this.hasIndex(b)){var e=this.store.index(b),f=this.indexComplies(e,a);f||(this.store.deleteIndex(b),this.store.createIndex(b,a.keyPath,{unique:a.unique,multiEntry:a.multiEntry})),d.splice(d.indexOf(b),1)}else this.store.createIndex(b,a.keyPath,{unique:a.unique,multiEntry:a.multiEntry})},this),d.length&&d.forEach(function(a){this.store.deleteIndex(a)},this)}.bind(this)},deleteDatabase:function(a,b){if(this.idb.deleteDatabase){this.db.close();var c=this.idb.deleteDatabase(this.dbName);c.onsuccess=a,c.onerror=b}else b(new Error("Browser does not support IndexedDB deleteDatabase!"))},put:function(a,b,e,f){null!==this.keyPath&&(f=e,e=b,b=a),f||(f=c),e||(e=d);var g,h=!1,i=null,j=this.db.transaction([this.storeName],this.consts.READ_WRITE);return j.oncomplete=function(){var a=h?e:f;a(i)},j.onabort=f,j.onerror=f,null!==this.keyPath?(this._addIdPropertyIfNeeded(b),g=j.objectStore(this.storeName).put(b)):g=j.objectStore(this.storeName).put(b,a),g.onsuccess=function(a){h=!0,i=a.target.result},g.onerror=f,j},get:function(a,b,e){e||(e=c),b||(b=d);var f=!1,g=null,h=this.db.transaction([this.storeName],this.consts.READ_ONLY);h.oncomplete=function(){var a=f?b:e;a(g)},h.onabort=e,h.onerror=e;var i=h.objectStore(this.storeName).get(a);return i.onsuccess=function(a){f=!0,g=a.target.result},i.onerror=e,h},remove:function(a,b,e){e||(e=c),b||(b=d);var f=!1,g=null,h=this.db.transaction([this.storeName],this.consts.READ_WRITE);h.oncomplete=function(){var a=f?b:e;a(g)},h.onabort=e,h.onerror=e;var i=h.objectStore(this.storeName).delete(a);return i.onsuccess=function(a){f=!0,g=a.target.result},i.onerror=e,h},batch:function(a,b,e){if(e||(e=c),b||(b=d),"[object Array]"!=Object.prototype.toString.call(a))e(new Error("dataArray argument must be of type Array."));else if(0===a.length)return b(!0);var f=a.length,g=!1,h=!1,i=this.db.transaction([this.storeName],this.consts.READ_WRITE);i.oncomplete=function(){var a=h?b:e;a(h)},i.onabort=e,i.onerror=e;var j=function(){f--,0!==f||g||(g=!0,h=!0)};return a.forEach(function(a){var b=a.type,c=a.key,d=a.value,f=function(a){i.abort(),g||(g=!0,e(a,b,c))};if("remove"==b){var h=i.objectStore(this.storeName).delete(c);h.onsuccess=j,h.onerror=f}else if("put"==b){var k;null!==this.keyPath?(this._addIdPropertyIfNeeded(d),k=i.objectStore(this.storeName).put(d)):k=i.objectStore(this.storeName).put(d,c),k.onsuccess=j,k.onerror=f}},this),i},putBatch:function(a,b,c){var d=a.map(function(a){return{type:"put",value:a}});return this.batch(d,b,c)},upsertBatch:function(a,b,e,f){"function"==typeof b&&(e=b,f=e,b={}),f||(f=c),e||(e=d),b||(b={}),"[object Array]"!=Object.prototype.toString.call(a)&&f(new Error("dataArray argument must be of type Array."));var g=b.keyField||this.keyPath,h=a.length,i=!1,j=!1,k=0,l=this.db.transaction([this.storeName],this.consts.READ_WRITE);l.oncomplete=function(){j?e(a):f(!1)},l.onabort=f,l.onerror=f;var m=function(b){var c=a[k++];c[g]=b.target.result,h--,0!==h||i||(i=!0,j=!0)};return a.forEach(function(a){var b,c=a.key,d=function(a){l.abort(),i||(i=!0,f(a))};null!==this.keyPath?(this._addIdPropertyIfNeeded(a),b=l.objectStore(this.storeName).put(a)):b=l.objectStore(this.storeName).put(a,c),b.onsuccess=m,b.onerror=d},this),l},removeBatch:function(a,b,c){var d=a.map(function(a){return{type:"remove",key:a}});return this.batch(d,b,c)},getBatch:function(a,b,e,f){if(e||(e=c),b||(b=d),f||(f="sparse"),"[object Array]"!=Object.prototype.toString.call(a))e(new Error("keyArray argument must be of type Array."));else if(0===a.length)return b([]);var g=[],h=a.length,i=!1,j=!1,k=null,l=this.db.transaction([this.storeName],this.consts.READ_ONLY);l.oncomplete=function(){var a=j?b:e;a(k)},l.onabort=e,l.onerror=e;var m=function(a){a.target.result||"dense"==f?g.push(a.target.result):"sparse"==f&&g.length++,h--,0===h&&(i=!0,j=!0,k=g)};return a.forEach(function(a){var b=function(a){i=!0,k=a,e(a),l.abort()},c=l.objectStore(this.storeName).get(a);c.onsuccess=m,c.onerror=b},this),l},getAll:function(a,b){b||(b=c),a||(a=d);var e=this.db.transaction([this.storeName],this.consts.READ_ONLY),f=e.objectStore(this.storeName);return f.getAll?this._getAllNative(e,f,a,b):this._getAllCursor(e,f,a,b),e},_getAllNative:function(a,b,c,d){var e=!1,f=null;a.oncomplete=function(){var a=e?c:d;a(f)},a.onabort=d,a.onerror=d;var g=b.getAll();g.onsuccess=function(a){e=!0,f=a.target.result},g.onerror=d},_getAllCursor:function(a,b,c,d){var e=[],f=!1,g=null;a.oncomplete=function(){var a=f?c:d;a(g)},a.onabort=d,a.onerror=d;var h=b.openCursor();h.onsuccess=function(a){var b=a.target.result;b?(e.push(b.value),b.continue()):(f=!0,g=e)},h.onError=d},clear:function(a,b){b||(b=c),a||(a=d);var e=!1,f=null,g=this.db.transaction([this.storeName],this.consts.READ_WRITE);g.oncomplete=function(){var c=e?a:b;c(f)},g.onabort=b,g.onerror=b;var h=g.objectStore(this.storeName).clear();return h.onsuccess=function(a){e=!0,f=a.target.result},h.onerror=b,g},_addIdPropertyIfNeeded:function(a){"undefined"==typeof a[this.keyPath]&&(a[this.keyPath]=this._insertIdCount++ +Date.now())},getIndexList:function(){return this.store.indexNames},hasIndex:function(a){return this.store.indexNames.contains(a)},normalizeIndexData:function(a){a.keyPath=a.keyPath||a.name,a.unique=!!a.unique,a.multiEntry=!!a.multiEntry},indexComplies:function(a,b){var c=["keyPath","unique","multiEntry"].every(function(c){if("multiEntry"==c&&void 0===a[c]&&b[c]===!1)return!0;if("keyPath"==c&&"[object Array]"==Object.prototype.toString.call(b[c])){var d=b.keyPath,e=a.keyPath;if("string"==typeof e)return d.toString()==e;if("function"!=typeof e.contains&&"function"!=typeof e.indexOf)return!1;if(e.length!==d.length)return!1;for(var f=0,g=d.length;f<g;f++)if(!(e.contains&&e.contains(d[f])||e.indexOf(d[f]!==-1)))return!1;return!0}return b[c]==a[c]});return c},iterate:function(b,d){d=a({index:null,order:"ASC",autoContinue:!0,filterDuplicates:!1,keyRange:null,writeAccess:!1,onEnd:null,onError:c,limit:1/0,offset:0,allowItemRejection:!1},d||{});var e="desc"==d.order.toLowerCase()?"PREV":"NEXT";d.filterDuplicates&&(e+="_NO_DUPLICATE");var f=!1,g=this.db.transaction([this.storeName],this.consts[d.writeAccess?"READ_WRITE":"READ_ONLY"]),h=g.objectStore(this.storeName);d.index&&(h=h.index(d.index));var i=0;g.oncomplete=function(){return f?void(d.onEnd?d.onEnd():b(null)):void d.onError(null)},g.onabort=d.onError,g.onerror=d.onError;var j=h.openCursor(d.keyRange,this.consts[e]);return j.onerror=d.onError,j.onsuccess=function(a){var c=a.target.result;if(c)if(d.offset)c.advance(d.offset),d.offset=0;else{var e=b(c.value,c,g);d.allowItemRejection&&e===!1||i++,d.autoContinue&&(i+d.offset<d.limit?c.continue():f=!0)}else f=!0},g},query:function(a,b){var c=[],d=0;return b=b||{},b.autoContinue=!0,b.writeAccess=!1,b.allowItemRejection=!!b.filter,b.onEnd=function(){a(c,d)},this.iterate(function(a){d++;var e=!b.filter||b.filter(a);return e!==!1&&c.push(a),e},b)},count:function(b,d){d=a({index:null,keyRange:null},d||{});var e=d.onError||c,f=!1,g=null,h=this.db.transaction([this.storeName],this.consts.READ_ONLY);h.oncomplete=function(){var a=f?b:e;a(g)},h.onabort=e,h.onerror=e;var i=h.objectStore(this.storeName);d.index&&(i=i.index(d.index));var j=i.count(d.keyRange);return j.onsuccess=function(a){f=!0,g=a.target.result},j.onError=e,h},makeKeyRange:function(a){var b,c="undefined"!=typeof a.lower,d="undefined"!=typeof a.upper,e="undefined"!=typeof a.only;switch(!0){case e:b=this.keyRange.only(a.only);break;case c&&d:b=this.keyRange.bound(a.lower,a.upper,a.excludeLower,a.excludeUpper);break;case c:b=this.keyRange.lowerBound(a.lower,a.excludeLower);break;case d:b=this.keyRange.upperBound(a.upper,a.excludeUpper);break;default:throw new Error('Cannot create KeyRange. Provide one or both of "lower" or "upper" value, or an "only" value.')}return b}},h={};return f.prototype=g,f.version=g.version,f},this)},{}],2:[function(a,b,c){function d(a,b){return _.result(a,"url")+(b.data?"?"+$.param(b.data):"")}function e(a,b){if(!a||!a[b])throw new Error('Setting missing. The FetchCache needs a setting: "'+b+'"')}var f=a("./SimpleStore"),g={modelFetch:Backbone.Model.prototype.fetch,modelSync:Backbone.Model.prototype.sync,collectionFetch:Backbone.Collection.prototype.fetch,collectionSync:Backbone.Collection.prototype.sync},h=function(a,b){var c=b.error;b.error=function(d){c&&c.call(b.context,a,d,b),a.trigger("error",a,d,b)}};Backbone.fetchCache={isInit:!1,enabled:!1,maxAge:1/0},Backbone.fetchCache.init=function(a,b){var c=Backbone.fetchCache;return c.settings=a||{},e(c.settings,"name"),Backbone.fetchCache.store=new f(c.settings,function(){c.isInit=!0,b&&b(c)}),c},Backbone.fetchCache.chechIfInit=function(){var a=Backbone.fetchCache;return a.isInit||window.console.warn('FetchCache is not initialized and therefore not active. Please initialize the store first by calling "Backbone.fetchcache.init"'),a.isInit},Backbone.fetchCache.clear=function(a){var b=Backbone.fetchCache;return b.chechIfInit()?(b.store.purge(function(){b.isInit=!1,delete b.store,a&&a.call(b)}),b):b},Backbone.Model.prototype.fetch=function(a){var b=this,c=new $.Deferred;if(a=_.extend({parse:!0},a),a.context=a.context||this,!Backbone.fetchCache.chechIfInit()||!Backbone.fetchCache.enabled&&!a.cache)return g.modelFetch.apply(this,arguments);var e=!1,f=a.success;a.success=function(g){function h(){var c=a.parse?b.parse(g,a):g;return b.clear({silent:!0}),!!b.set(c,a)&&(f&&f.call(a.context,b,g,a),void b.trigger("sync",b,g,a))}if(c.resolveWith(a.context,[b]),e)h();else{var i=d(b,a),j={timestamp:(new Date).getTime(),data:g};Backbone.fetchCache.store.setItem(i,j,function(){h()})}},h(this,a);var i=d(b,a);return Backbone.fetchCache.store.getItem(i,function(d){if(d){if(!d.timestamp)throw new Error("Cache data has no timestamp");if(!d.data)throw new Error("Cache data has no data");var f=_.result(a,"maxAge");f=_.isNumber(f)?f:Backbone.fetchCache.maxAge,f*=1e3;var h=Math.round((new Date).getTime()-d.timestamp);if(h<f)return e=!0,void a.success.call(b,d.data)}e=!1;var i=g.modelSync.call(b,"read",b,a);i.done(_.bind(c.resolve,a.context,b)).fail(_.bind(c.reject,a.context,b)),c.abort=i.abort},function(){window.console.error("error")}),c.promise()},Backbone.Collection.prototype.fetch=function(a){var b=this,c=new $.Deferred;if(a=_.extend({parse:!0},a),a.context=a.context||this,!Backbone.fetchCache.chechIfInit()||!Backbone.fetchCache.enabled&&!a.cache)return g.collectionFetch.apply(this,arguments);var e=!1,f=a.success;a.success=function(g){function h(){var d=a.reset?"reset":"set";b[d](g,a),f&&f.call(a.context,b,g,a),b.trigger("sync",b,g,a),c.resolveWith(a.context,[b])}if(e)h();else{var i=d(b,a),j={timestamp:(new Date).getTime(),data:g};Backbone.fetchCache.store.setItem(i,j,function(){h()})}},h(this,a);var i=d(b,a);return Backbone.fetchCache.store.getItem(i,function(d){if(d){if(!d.timestamp)throw new Error("Cache data has no timestamp");if(!d.data)throw new Error("Cache data has no data");var f=_.result(a,"maxAge");f=_.isNumber(f)?f:Backbone.fetchCache.maxAge,f*=1e3;var h=Math.round((new Date).getTime()-d.timestamp);if(h<f)return e=!0,void a.success.call(b,d.data)}e=!1;var i=g.collectionSync.call(b,"read",b,a);i.done(_.bind(c.resolve,a.context,b)).fail(_.bind(c.reject,a.context,b)),c.abort=i.abort},function(){window.console.error("error")}),c.promise()},b.exports=Backbone},{"./SimpleStore":3}],3:[function(a,b,c){function d(a){throw new Error(a)}var e=a("idb-wrapper"),f=function(a,b){var c=this;return this.settings=a||{},this.settings.name=a.name||"store",this.idb=new e({storeName:c.settings.name,keyPath:null,autoIncrement:!1,onError:d,onStoreReady:function(){b(c.idb)}}),this};f.prototype._formatKey=function(a){return a},f.prototype._serializeData=function(a){return a?JSON.stringify(a):null},f.prototype._deSerializeData=function(a){return a?JSON.parse(a):null},f.prototype.setItem=function(a,b,c,e){var f=this;return f.idb.put(f._formatKey(a),f._serializeData(b),c,e||d),f},f.prototype.getItem=function(a,b,c){var e=this;return e.idb.get(e._formatKey(a),function(a){b(e._deSerializeData(a))},c||d),e},f.prototype.purge=function(a,b){var c=this;return c.idb.clear(a,b||d),delete c.idb,c},b.exports=f},{"idb-wrapper":1}]},{},[2,3]);