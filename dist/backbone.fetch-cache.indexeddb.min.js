/**
 * @see https://github.com/mojoaxel/backbone-fetch-cache-indexeddb#backbone-fetch-cache-indexeddb
 * @copyright 2018 by Alexander Wunschik <mail@wunschik.it>
 * @version 4.5.7
 * @license MIT
 */

!function e(t,r,n){function o(a,s){if(!r[a]){if(!t[a]){var c="function"==typeof require&&require;if(!s&&c)return c(a,!0);if(i)return i(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var h=r[a]={exports:{}};t[a][0].call(h.exports,function(e){var r=t[a][1][e];return o(r||e)},h,h.exports,e,t,r,n)}return r[a].exports}for(var i="function"==typeof require&&require,a=0;a<n.length;a++)o(n[a]);return o}({1:[function(e,t,r){!function(e,r,n){"use strict";"function"==typeof define?define(r):void 0!==t&&t.exports?t.exports=r():n.IDBStore=r()}(0,function(){"use strict";function e(e,t){var r,n;for(r in t)(n=t[r])!==s[r]&&n!==e[r]&&(e[r]=n);return e}function t(e){return"error"in e.target?"VersionError"==e.target.error.name:"errorCode"in e.target&&12==e.target.errorCode}var r=function(e){throw e},n=function(){},o={storeName:"Store",storePrefix:"IDBWrapper-",dbVersion:1,keyPath:"id",autoIncrement:!0,onStoreReady:function(){},onError:r,indexes:[],implementationPreference:["indexedDB","webkitIndexedDB","mozIndexedDB","shimIndexedDB"]},i=function(e,t){void 0===t&&"function"==typeof e&&(t=e),"[object Object]"!=Object.prototype.toString.call(e)&&(e={});for(var r in o)this[r]=void 0!==e[r]?e[r]:o[r];this.dbName=this.storePrefix+this.storeName,this.dbVersion=parseInt(this.dbVersion,10)||1,t&&(this.onStoreReady=t);var n="object"==typeof window?window:self,i=this.implementationPreference.filter(function(e){return e in n});if(this.implementation=i[0],this.idb=n[this.implementation],!this.idb)return this.onError(new Error("Could not find any indexedDB implementation. Please update your browser or change your Privacy settings."));this.keyRange=n.IDBKeyRange||n.webkitIDBKeyRange||n.mozIDBKeyRange,this.consts={READ_ONLY:"readonly",READ_WRITE:"readwrite",VERSION_CHANGE:"versionchange",NEXT:"next",NEXT_NO_DUPLICATE:"nextunique",PREV:"prev",PREV_NO_DUPLICATE:"prevunique"},this.openDB()},a={constructor:i,version:"1.7.1",db:null,dbName:null,dbVersion:null,store:null,storeName:null,storePrefix:null,keyPath:null,autoIncrement:null,indexes:null,implementationPreference:null,implementation:"",onStoreReady:null,onError:null,_insertIdCount:0,openDB:function(){var e=this.idb.open(this.dbName,this.dbVersion),r=!1;e.onerror=function(e){if(t(e))this.onError(new Error("The version number provided is lower than the existing one."));else{var r;if(e.target.error)r=e.target.error;else{var n="IndexedDB unknown error occurred when opening DB "+this.dbName+" version "+this.dbVersion;"errorCode"in e.target&&(n+=" with error code "+e.target.errorCode),r=new Error(n)}this.onError(r)}}.bind(this),e.onsuccess=function(e){if(!r)if(this.db)this.onStoreReady();else if(this.db=e.target.result,"string"!=typeof this.db.version)if(this.db.objectStoreNames.contains(this.storeName)){var t=this.db.transaction([this.storeName],this.consts.READ_ONLY);this.store=t.objectStore(this.storeName);var n=Array.prototype.slice.call(this.getIndexList());this.indexes.forEach(function(e){var t=e.name;if(!t)return r=!0,void this.onError(new Error("Cannot create index: No index name given."));if(this.normalizeIndexData(e),this.hasIndex(t)){var o=this.store.index(t);this.indexComplies(o,e)||(r=!0,this.onError(new Error('Cannot modify index "'+t+'" for current version. Please bump version number to '+(this.dbVersion+1)+"."))),n.splice(n.indexOf(t),1)}else r=!0,this.onError(new Error('Cannot create new index "'+t+'" for current version. Please bump version number to '+(this.dbVersion+1)+"."))},this),n.length&&(r=!0,this.onError(new Error('Cannot delete index(es) "'+n.toString()+'" for current version. Please bump version number to '+(this.dbVersion+1)+"."))),r||this.onStoreReady()}else this.onError(new Error("Object store couldn't be created."));else this.onError(new Error("The IndexedDB implementation in this browser is outdated. Please upgrade your browser."))}.bind(this),e.onupgradeneeded=function(e){if(this.db=e.target.result,this.db.objectStoreNames.contains(this.storeName))this.store=e.target.transaction.objectStore(this.storeName);else{var t={autoIncrement:this.autoIncrement};null!==this.keyPath&&(t.keyPath=this.keyPath),this.store=this.db.createObjectStore(this.storeName,t)}var n=Array.prototype.slice.call(this.getIndexList());this.indexes.forEach(function(e){var t=e.name;if(t||(r=!0,this.onError(new Error("Cannot create index: No index name given."))),this.normalizeIndexData(e),this.hasIndex(t)){var o=this.store.index(t);this.indexComplies(o,e)||(this.store.deleteIndex(t),this.store.createIndex(t,e.keyPath,{unique:e.unique,multiEntry:e.multiEntry})),n.splice(n.indexOf(t),1)}else this.store.createIndex(t,e.keyPath,{unique:e.unique,multiEntry:e.multiEntry})},this),n.length&&n.forEach(function(e){this.store.deleteIndex(e)},this)}.bind(this)},deleteDatabase:function(e,t){if(this.idb.deleteDatabase){this.db.close();var r=this.idb.deleteDatabase(this.dbName);r.onsuccess=e,r.onerror=t}else t(new Error("Browser does not support IndexedDB deleteDatabase!"))},put:function(e,t,o,i){null!==this.keyPath&&(i=o,o=t,t=e),i||(i=r),o||(o=n);var a,s=!1,c=null,u=this.db.transaction([this.storeName],this.consts.READ_WRITE);return u.oncomplete=function(){(s?o:i)(c)},u.onabort=i,u.onerror=i,null!==this.keyPath?(this._addIdPropertyIfNeeded(t),a=u.objectStore(this.storeName).put(t)):a=u.objectStore(this.storeName).put(t,e),a.onsuccess=function(e){s=!0,c=e.target.result},a.onerror=i,u},get:function(e,t,o){o||(o=r),t||(t=n);var i=!1,a=null,s=this.db.transaction([this.storeName],this.consts.READ_ONLY);s.oncomplete=function(){(i?t:o)(a)},s.onabort=o,s.onerror=o;var c=s.objectStore(this.storeName).get(e);return c.onsuccess=function(e){i=!0,a=e.target.result},c.onerror=o,s},remove:function(e,t,o){o||(o=r),t||(t=n);var i=!1,a=null,s=this.db.transaction([this.storeName],this.consts.READ_WRITE);s.oncomplete=function(){(i?t:o)(a)},s.onabort=o,s.onerror=o;var c=s.objectStore(this.storeName).delete(e);return c.onsuccess=function(e){i=!0,a=e.target.result},c.onerror=o,s},batch:function(e,t,o){if(o||(o=r),t||(t=n),"[object Array]"!=Object.prototype.toString.call(e))o(new Error("dataArray argument must be of type Array."));else if(0===e.length)return t(!0);var i=e.length,a=!1,s=!1,c=this.db.transaction([this.storeName],this.consts.READ_WRITE);c.oncomplete=function(){(s?t:o)(s)},c.onabort=o,c.onerror=o;var u=function(){0!==--i||a||(a=!0,s=!0)};return e.forEach(function(e){var t=e.type,r=e.key,n=e.value,i=function(e){c.abort(),a||(a=!0,o(e,t,r))};if("remove"==t){var s=c.objectStore(this.storeName).delete(r);s.onsuccess=u,s.onerror=i}else if("put"==t){var h;null!==this.keyPath?(this._addIdPropertyIfNeeded(n),h=c.objectStore(this.storeName).put(n)):h=c.objectStore(this.storeName).put(n,r),h.onsuccess=u,h.onerror=i}},this),c},putBatch:function(e,t,r){var n=e.map(function(e){return{type:"put",value:e}});return this.batch(n,t,r)},upsertBatch:function(e,t,o,i){"function"==typeof t&&(i=o=t,t={}),i||(i=r),o||(o=n),t||(t={}),"[object Array]"!=Object.prototype.toString.call(e)&&i(new Error("dataArray argument must be of type Array."));var a=t.keyField||this.keyPath,s=e.length,c=!1,u=!1,h=0,l=this.db.transaction([this.storeName],this.consts.READ_WRITE);l.oncomplete=function(){u?o(e):i(!1)},l.onabort=i,l.onerror=i;var f=function(t){e[h++][a]=t.target.result,0!==--s||c||(c=!0,u=!0)};return e.forEach(function(e){var t,r=e.key;null!==this.keyPath?(this._addIdPropertyIfNeeded(e),t=l.objectStore(this.storeName).put(e)):t=l.objectStore(this.storeName).put(e,r),t.onsuccess=f,t.onerror=function(e){l.abort(),c||(c=!0,i(e))}},this),l},removeBatch:function(e,t,r){var n=e.map(function(e){return{type:"remove",key:e}});return this.batch(n,t,r)},getBatch:function(e,t,o,i){if(o||(o=r),t||(t=n),i||(i="sparse"),"[object Array]"!=Object.prototype.toString.call(e))o(new Error("keyArray argument must be of type Array."));else if(0===e.length)return t([]);var a=[],s=e.length,c=!1,u=!1,h=null,l=this.db.transaction([this.storeName],this.consts.READ_ONLY);l.oncomplete=function(){(u?t:o)(h)},l.onabort=o,l.onerror=o;var f=function(e){e.target.result||"dense"==i?a.push(e.target.result):"sparse"==i&&a.length++,0===--s&&(c=!0,u=!0,h=a)};return e.forEach(function(e){var t=l.objectStore(this.storeName).get(e);t.onsuccess=f,t.onerror=function(e){c=!0,h=e,o(e),l.abort()}},this),l},getAll:function(e,t){t||(t=r),e||(e=n);var o=this.db.transaction([this.storeName],this.consts.READ_ONLY),i=o.objectStore(this.storeName);return i.getAll?this._getAllNative(o,i,e,t):this._getAllCursor(o,i,e,t),o},_getAllNative:function(e,t,r,n){var o=!1,i=null;e.oncomplete=function(){(o?r:n)(i)},e.onabort=n,e.onerror=n;var a=t.getAll();a.onsuccess=function(e){o=!0,i=e.target.result},a.onerror=n},_getAllCursor:function(e,t,r,n){var o=[],i=!1,a=null;e.oncomplete=function(){(i?r:n)(a)},e.onabort=n,e.onerror=n;var s=t.openCursor();s.onsuccess=function(e){var t=e.target.result;t?(o.push(t.value),t.continue()):(i=!0,a=o)},s.onError=n},clear:function(e,t){t||(t=r),e||(e=n);var o=!1,i=null,a=this.db.transaction([this.storeName],this.consts.READ_WRITE);a.oncomplete=function(){(o?e:t)(i)},a.onabort=t,a.onerror=t;var s=a.objectStore(this.storeName).clear();return s.onsuccess=function(e){o=!0,i=e.target.result},s.onerror=t,a},_addIdPropertyIfNeeded:function(e){void 0===e[this.keyPath]&&(e[this.keyPath]=this._insertIdCount+++Date.now())},getIndexList:function(){return this.store.indexNames},hasIndex:function(e){return this.store.indexNames.contains(e)},normalizeIndexData:function(e){e.keyPath=e.keyPath||e.name,e.unique=!!e.unique,e.multiEntry=!!e.multiEntry},indexComplies:function(e,t){return["keyPath","unique","multiEntry"].every(function(r){if("multiEntry"==r&&void 0===e[r]&&!1===t[r])return!0;if("keyPath"==r&&"[object Array]"==Object.prototype.toString.call(t[r])){var n=t.keyPath,o=e.keyPath;if("string"==typeof o)return n.toString()==o;if("function"!=typeof o.contains&&"function"!=typeof o.indexOf)return!1;if(o.length!==n.length)return!1;for(var i=0,a=n.length;i<a;i++)if(!(o.contains&&o.contains(n[i])||o.indexOf(-1!==n[i])))return!1;return!0}return t[r]==e[r]})},iterate:function(t,n){var o="desc"==(n=e({index:null,order:"ASC",autoContinue:!0,filterDuplicates:!1,keyRange:null,writeAccess:!1,onEnd:null,onError:r,limit:1/0,offset:0,allowItemRejection:!1},n||{})).order.toLowerCase()?"PREV":"NEXT";n.filterDuplicates&&(o+="_NO_DUPLICATE");var i=!1,a=this.db.transaction([this.storeName],this.consts[n.writeAccess?"READ_WRITE":"READ_ONLY"]),s=a.objectStore(this.storeName);n.index&&(s=s.index(n.index));var c=0;a.oncomplete=function(){i?n.onEnd?n.onEnd():t(null):n.onError(null)},a.onabort=n.onError,a.onerror=n.onError;var u=s.openCursor(n.keyRange,this.consts[o]);return u.onerror=n.onError,u.onsuccess=function(e){var r=e.target.result;if(r)if(n.offset)r.advance(n.offset),n.offset=0;else{var o=t(r.value,r,a);n.allowItemRejection&&!1===o||c++,n.autoContinue&&(c+n.offset<n.limit?r.continue():i=!0)}else i=!0},a},query:function(e,t){var r=[],n=0;return t=t||{},t.autoContinue=!0,t.writeAccess=!1,t.allowItemRejection=!!t.filter,t.onEnd=function(){e(r,n)},this.iterate(function(e){n++;var o=!t.filter||t.filter(e);return!1!==o&&r.push(e),o},t)},count:function(t,n){var o=(n=e({index:null,keyRange:null},n||{})).onError||r,i=!1,a=null,s=this.db.transaction([this.storeName],this.consts.READ_ONLY);s.oncomplete=function(){(i?t:o)(a)},s.onabort=o,s.onerror=o;var c=s.objectStore(this.storeName);n.index&&(c=c.index(n.index));var u=c.count(n.keyRange);return u.onsuccess=function(e){i=!0,a=e.target.result},u.onError=o,s},makeKeyRange:function(e){var t,r=void 0!==e.lower,n=void 0!==e.upper;switch(!0){case void 0!==e.only:t=this.keyRange.only(e.only);break;case r&&n:t=this.keyRange.bound(e.lower,e.upper,e.excludeLower,e.excludeUpper);break;case r:t=this.keyRange.lowerBound(e.lower,e.excludeLower);break;case n:t=this.keyRange.upperBound(e.upper,e.excludeUpper);break;default:throw new Error('Cannot create KeyRange. Provide one or both of "lower" or "upper" value, or an "only" value.')}return t}},s={};return i.prototype=a,i.version=a.version,i},this)},{}],2:[function(e,t,r){function n(e,t){t=t||{};var r=_.result(e,"url");if(_.isUndefined(r)||!r.length)throw window.console.warn(JSON.stringify(e)),new Error('The model/collection is missing the "url" property or function');return r+(t.data?"?"+$.param(t.data):"")}function o(e,t){if(t=t||{},_.isUndefined(t.name)||_.isNull(t.name))throw new Error('Setting missing. The FetchCache needs a "name"');if(!_.isString(t.name)||t.name.trim().length<=0)throw new Error('The "name" parameter must be a valid String');return e.name=t.name,_.isBoolean(t.enabled)&&(e.enabled=t.enabled),_.isFinite(t.maxAge)&&(e.maxAge=t.maxAge),e}function i(e){function t(){l=!1;var t=s[o].fetch.call(i,e);h.abort=t.abort,h=_.extend(h,_.pick(t,function(e,t,r){return!_.isFunction(e)})),t.then(_.bind(u.resolve,a),_.bind(u.reject,a),function(e,t,r){h=_.extend(h,_.pick(r,function(e,t,r){return!_.isFunction(e)}))})}var r="model",o=this instanceof Backbone.Model?r:"collection",i=this;if(e=_.extend({parse:!0},e),_.isBoolean(e.cache)&&!1===e.cache||!1===Backbone.fetchCache.enabled&&_.isUndefined(e.cache)||!Backbone.fetchCache.checkIfInit())return s[o].fetch.call(i,e);var a=e.context||this,u=new $.Deferred,h=u.promise();h.abort=_.bind(u.reject,a);var l=!1,f=n(i,e),d=c(this,e)||Backbone.fetchCache.onError,m=e.success;return e.success=function(t,n,i){function s(i){var s=e.parse?t.parse(i,e):i;if(e.parse=!1,o===r){if(!t.set(s,e))return!1}else{var c=e.reset?"reset":"set";t[c](s,e)}m&&m.call(a,t,s,e),t.trigger("sync",t,n,e)}if(l)s(n);else{var c={timestamp:(new Date).getTime(),data:n};Backbone.fetchCache.store.setItem(f,c,function(){Backbone.fetchCache.trigger("setitem",f,c),s(c.data)},function(e){d(e),s(c.data)})}},i.trigger("cacherequest",i,e),Backbone.fetchCache.store.getItem(f,function(r){if(r){if(!r.timestamp)throw new Error("Cache data has no timestamp");var n=_.result(e,"maxAge");n=_.isNumber(n)?n:Backbone.fetchCache.maxAge,n*=1e3;var o=Math.round((new Date).getTime()-r.timestamp);if(Backbone.fetchCache.trigger("getitem",f,r,n),o<n)return l=!0,void e.success.call(i,i,r.data);Backbone.fetchCache.trigger("aged",f,r,n),t()}else Backbone.fetchCache.trigger("notfound",f),t()},function(e){t()}),h}var a=e("./SimpleStore"),s={model:{fetch:Backbone.Model.prototype.fetch,sync:Backbone.Model.prototype.sync},collection:{fetch:Backbone.Collection.prototype.fetch,sync:Backbone.Collection.prototype.sync}},c=function(e,t){var r=(t=t||{}).error,n=t.context||e;return t.error=function(e,t,o){r&&r.call(n,e,t,o),Backbone.fetchCache.trigger("error",t),e.trigger("error",e,t,o)},r};Backbone.fetchCache={isInit:!1,enabled:!1,maxAge:1/0,onError:function(e){Backbone.fetchCache.trigger("error",e)}},_.extend(Backbone.fetchCache,Backbone.Events),Backbone.fetchCache.init=function(e,t){var r=Backbone.fetchCache;return r=o(r,e),Backbone.fetchCache.store=new a({name:r.name},function(){r.isInit=!0,t&&t(r)},r.onError),r},Backbone.fetchCache.checkIfInit=function(){var e=Backbone.fetchCache;return e.isInit,e.isInit||window.console.warn('FetchCache is not initialized and therefore not active. Please initialize the store first by calling "Backbone.fetchcache.init"'),e.isInit},Backbone.fetchCache.clear=function(e){var t=Backbone.fetchCache;return t.checkIfInit()?(t.store.clear(function(){t.trigger("clear",t),e&&e(t)}),t):t},Backbone.fetchCache.purge=function(e){var t=Backbone.fetchCache;return t.isInit?(t.store.purge(function(){t.isInit=!1,delete t.store,t.trigger("clear",t),t.stopListening(),e&&e(t)}),t):(e&&e(t),t)},Backbone.Model.prototype.fetch=i,Backbone.Collection.prototype.fetch=i,t.exports=Backbone},{"./SimpleStore":3}],3:[function(e,t,r){function n(e){throw new Error(e)}var o=e("idb-wrapper"),i=function(e,t,r){var i=this;return i.settings=e||{},i.settings.name=e.name||"store",i.idb=new o({storeName:i.settings.name,keyPath:null,autoIncrement:!1,onError:r||n,onStoreReady:function(){t(i.idb)}}),this};i.prototype._formatKey=function(e){return e},i.prototype._serializeData=function(e){return e?JSON.stringify(e):null},i.prototype._deSerializeData=function(e){return e?JSON.parse(e):null},i.prototype.setItem=function(e,t,r,o){var i=this;return i.idb.put(i._formatKey(e),i._serializeData(t),r,o||n),i},i.prototype.getItem=function(e,t,r){var o=this;try{o.idb.get(o._formatKey(e),function(e){t(o._deSerializeData(e))},r||n)}catch(e){(r||n)(e)}return o},i.prototype.clear=function(e,t){var r=this;return r.idb.clear(e,t||n),r},i.prototype.purge=function(e,t){var r=this;return r.idb.clear(function(){r.idb.deleteDatabase(),delete r.idb,e&&e()},t||n),r},t.exports=i},{"idb-wrapper":1}]},{},[2,3]);